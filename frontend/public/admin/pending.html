<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pending Signups — Admin</title>
  <style>
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#f3f6f9;margin:0;padding:20px}
    .wrap{max-width:960px;margin:20px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #eef2f7;text-align:left}
    th{background:#fbfcfd;font-weight:600}
    button{background:#0593c6;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .danger{background:#ef4444}
    .muted{color:#64748b;font-size:0.9rem}
    .small{font-size:0.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Pending Signups</h2>
    <p class="muted">Only admins can access this page. Sign in as admin in the same browser so the session cookie is present.</p>
    <div id="msg" class="muted"></div>
    <div style="overflow:auto;margin-top:12px">
      <table id="tbl">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Email</th><th>Type</th><th>Customer</th><th>Phone</th><th>Country</th><th>Place</th><th>Submitted</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE_URL =
      window.location.hostname === 'localhost'
        ? 'http://localhost:4000'
        : 'https://gcc-control-tower-login.onrender.com';
    async function loadPending(){
      const msg = document.getElementById('msg');
      msg.textContent = 'Loading...';
      try{
        const res = await fetch(API_BASE_URL + '/auth/pending', { credentials: 'include' });
        if (!res.ok) {
          const d = await res.json().catch(()=>({}));
          msg.textContent = d.error || 'Failed to load — are you signed in as admin?';
          return;
        }
        const list = await res.json();
        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="10" class="small muted">No pending signups</td></tr>';
          msg.textContent = '';
          return;
        }
        for(const u of list){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.name || ''}</td>
            <td>${u.email}</td>
            <td>${u.signupType || ''}</td>
            <td>${u.customerName || ''}</td>
            <td>${u.phone || ''}</td>
            <td>${u.country || ''}</td>
            <td>${u.place || ''}</td>
            <td>${new Date(u.createdAt).toLocaleString()}</td>
            <td><button data-id="${u.id}" class="approve">Approve</button></td>
          `;
          tbody.appendChild(tr);
        }
        msg.textContent = '';
      }catch(err){
        msg.textContent = 'Network error';
      }
    }

    document.addEventListener('click', async (e)=>{
      if (e.target && e.target.matches('button.approve')){
        const id = e.target.getAttribute('data-id');
        e.target.disabled = true; e.target.textContent = 'Approving...';
        try{
          const res = await fetch(API_BASE_URL + '/auth/approve/' + id, { method: 'POST', credentials: 'include' });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) {
            alert(data.error || 'Failed to approve');
            e.target.disabled = false; e.target.textContent = 'Approve';
            return;
          }
          // show token to admin so they can send to user
          alert('Approved. Reset token:\n' + (data.resetToken || 'N/A') + '\n\nSend this token to the user so they can set their password at /password-set.html');
          loadPending();
        }catch(err){
          alert('Network error');
          e.target.disabled = false; e.target.textContent = 'Approve';
        }
      }
    });

    loadPending();
  </script>
</body>
</html>