<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Set Password — GCC Control Tower</title>
    <style>
      body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(135deg,#071627 0%, #032c44 100%);color:#0f172a;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
      .card{width:100%;max-width:480px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
      input,button{width:100%;padding:10px;margin-top:8px;box-sizing:border-box}
      button{background:#059669;color:#fff;border:0;border-radius:6px;cursor:pointer}
      .muted{font-size:0.9rem;color:#6b7280}
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Set your password</h2>

      <!-- Step 1: Check email status -->
      <div>
        <label>Email (user ID)</label>
        <input id="email" type="email" required />
        <button id="checkStatusBtn" type="button">Check status</button>
      </div>

      <!-- Step 2a: First-time password set (requires token from email) -->
      <form id="pwFormFirst" style="margin-top:16px;display:none;">
        <p class="muted">First-time setup: use the token from your approval email.</p>
        <label>Token</label>
        <input id="token" />
        <label>New password</label>
        <input id="passwordFirst" type="password" required />
        <label>Confirm password</label>
        <input id="confirmFirst" type="password" required />
        <button type="submit">Set password</button>
      </form>

      <!-- Step 2b: Subsequent password change (requires old password) -->
      <form id="pwFormChange" style="margin-top:16px;display:none;">
        <p class="muted">Change password: verify your current password, then choose a new one.</p>
        <label>Old password</label>
        <input id="oldPassword" type="password" required />
        <label>New password</label>
        <input id="newPassword" type="password" required />
        <label>Confirm password</label>
        <input id="confirmNew" type="password" required />
        <button type="submit">Change password</button>
      </form>

      <p id="msg" style="color:#b91c1c"></p>
      <p class="muted">Use the email you signed up with. Only approved requests can set a password.</p>
      <p class="muted" style="margin-top:12px"><a href="/login.html">&larr; Return to login</a></p>
    </div>

    <script>
      const API_BASE_URL =
        window.location.hostname === 'localhost'
          ? 'http://localhost:4000'
          : 'https://gcc-control-tower-login.onrender.com';
      const msg = document.getElementById('msg');
      const emailInput = document.getElementById('email');
      const pwFormFirst = document.getElementById('pwFormFirst');
      const pwFormChange = document.getElementById('pwFormChange');
      const checkBtn = document.getElementById('checkStatusBtn');

      // prefill token from query for first-time setup
      const params = new URLSearchParams(location.search);
      const tokenFromQuery = params.get('token');
      if (tokenFromQuery) document.getElementById('token').value = tokenFromQuery;

      checkBtn.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        msg.textContent = '';
        pwFormFirst.style.display = 'none';
        pwFormChange.style.display = 'none';

        if (!email) {
          msg.textContent = 'Email is required';
          return;
        }

        try {
          const statusRes = await fetch(API_BASE_URL + '/auth/signup-status?email=' + encodeURIComponent(email));
          const statusData = await statusRes.json().catch(() => ({}));
          if (!statusRes.ok) {
            msg.textContent = statusData.error || 'Failed to check status';
            return;
          }
          if (statusData.status === 'declined') {
            alert('Your request has been declined.');
            msg.textContent = 'Your request has been declined.';
            return;
          }
          if (statusData.status === 'pending') {
            msg.textContent = 'Your signup is still pending approval. Please try again later.';
            return;
          }
          if (statusData.status === 'not_found') {
            msg.textContent = 'No signup request found for this email.';
            return;
          }

          // Approved: decide whether this is first-time setup or a later change
          if (statusData.mustSetPassword) {
            msg.textContent = 'Your signup is approved. You can now set your password for the first time.';
            pwFormFirst.style.display = 'block';
            pwFormChange.style.display = 'none';
          } else {
            msg.textContent = 'Your account is already active. You can change your password below.';
            pwFormFirst.style.display = 'none';
            pwFormChange.style.display = 'block';
          }
        } catch (err) {
          msg.textContent = 'Network error';
        }
      });

      // First-time password set (token + new password)
      pwFormFirst.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = document.getElementById('token').value.trim();
        const password = document.getElementById('passwordFirst').value;
        const confirm = document.getElementById('confirmFirst').value;
        msg.textContent = '';

        if (!password || !confirm) {
          msg.textContent = 'Password and confirm password are required';
          return;
        }
        if (password !== confirm) {
          msg.textContent = 'Passwords do not match';
          return;
        }

        try {
          const res = await fetch(API_BASE_URL + '/auth/set-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, password })
          });
          const data = await res.json();
          if (res.ok) {
            alert('Password set — please login');
            location.href = '/login.html';
            return;
          }
          msg.textContent = data.error || 'Failed';
        } catch (err) {
          msg.textContent = 'Network error';
        }
      });

      // Subsequent password change (old password + new password)
      pwFormChange.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim();
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNew = document.getElementById('confirmNew').value;
        msg.textContent = '';

        if (!oldPassword || !newPassword || !confirmNew) {
          msg.textContent = 'All password fields are required';
          return;
        }
        if (newPassword !== confirmNew) {
          msg.textContent = 'New passwords do not match';
          return;
        }

        try {
          const res = await fetch(API_BASE_URL + '/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, oldPassword, newPassword })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok) {
            alert('Password changed — please login');
            location.href = '/login.html';
            return;
          }
          msg.textContent = data.error || 'Failed to change password';
        } catch (err) {
          msg.textContent = 'Network error';
        }
      });
    </script>
  </body>
</html>
